<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>utils.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module-client-Freshdesk.html">Freshdesk</a><ul class='methods'><li data-type='method'><a href="module-client-Freshdesk.html#listAllTickets">listAllTickets</a></li><li data-type='method'><a href="module-client-Freshdesk.html#filterTickets">filterTickets</a></li><li data-type='method'><a href="module-client-Freshdesk.html#filterContacts">filterContacts</a></li><li data-type='method'><a href="module-client-Freshdesk.html#getAgent">getAgent</a></li><li data-type='method'><a href="module-client-Freshdesk.html#listAllAgents">listAllAgents</a></li><li data-type='method'><a href="module-client-Freshdesk.html#updateAgent">updateAgent</a></li><li data-type='method'><a href="module-client-Freshdesk.html#deleteAgent">deleteAgent</a></li><li data-type='method'><a href="module-client-Freshdesk.html#currentAgent">currentAgent</a></li><li data-type='method'><a href="module-client-Freshdesk.html#getRole">getRole</a></li><li data-type='method'><a href="module-client-Freshdesk.html#listAllRoles">listAllRoles</a></li><li data-type='method'><a href="module-client-Freshdesk.html#createCompany">createCompany</a></li><li data-type='method'><a href="module-client-Freshdesk.html#getCompany">getCompany</a></li><li data-type='method'><a href="module-client-Freshdesk.html#searchCompany">searchCompany</a></li><li data-type='method'><a href="module-client-Freshdesk.html#listAllCompanies">listAllCompanies</a></li><li data-type='method'><a href="module-client-Freshdesk.html#filterCompanies">filterCompanies</a></li><li data-type='method'><a href="module-client-Freshdesk.html#updateCompany">updateCompany</a></li><li data-type='method'><a href="module-client-Freshdesk.html#deleteCompany">deleteCompany</a></li><li data-type='method'><a href="module-client-Freshdesk.html#createTimeEntry">createTimeEntry</a></li><li data-type='method'><a href="module-client-Freshdesk.html#listAllTimeEntries">listAllTimeEntries</a></li><li data-type='method'><a href="module-client-Freshdesk.html#updateTimeEntry">updateTimeEntry</a></li><li data-type='method'><a href="module-client-Freshdesk.html#toggleTimer">toggleTimer</a></li><li data-type='method'><a href="module-client-Freshdesk.html#deleteTimeEntry">deleteTimeEntry</a></li><li data-type='method'><a href="module-client-Freshdesk.html#getSettings">getSettings</a></li></ul></li><li><a href="module-utils-FreshdeskError.html">FreshdeskError</a></li></ul><h3>Modules</h3><ul><li><a href="module-client.html">client</a></li><li><a href="module-utils.html">utils</a><ul class='methods'><li data-type='method'><a href="module-utils.html#~isNil">isNil</a></li><li data-type='method'><a href="module-utils.html#~isFunction">isFunction</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">utils.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
Node wrapper for Freshdesk v2 API

Copyright (C) 2016-2018 Arjun Komath &lt;arjunkomath@gmail.com>
Copyright (C) 2016-2018 Maksim Koryukov &lt;maxkoryukov@gmail.com>

This program is free software: you can redistribute it and/or modify
it under the terms of the MIT License, attached to this software package.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

You should have received a copy of the MIT License along with this
program. If not, see &lt;https://opensource.org/licenses/MIT>.

http://spdx.org/licenses/MIT
*/

/**
 * Freshdesk API utilities
 *
 * @module
 */

'use strict'

const axios = require('axios')
const debug = require('debug')('freshdesk-api')
const FormData = require('form-data');

/**
 * Freshdesk's API protocol violations
 *
 * @param {String}  message Error message
 * @param {Number}  status  HTTP status of the received Freshdesk-response. Could be useful for debugging
 * @param {Object}  data    Parsed response of the Freshdesk API
 */
class FreshdeskError extends Error{
	constructor (message, data, res) {
		super()

		this.name = 'FreshdeskError'
		this.message = message || 'Error in Freshdesk\'s client API'
		this.stack = (new Error()).stack

		this.data = data

		this.status = res.status
		this.apiTarget = `${res.request.method} ${res.request.path}`
		this.requestId = res.headers['x-request-id']
	}
}


function createResponseHandler (cb) {
	return function (error, response, body) {
		if (error) {
			debug('Error on request: [%s], req path [%s] raw body: %o',
				error
			)
			return cb(error)
		}

		let data = null
		const extra = {
			pageIsLast: true,
			requestId: '',
		}

		debug('Got API response, status [%s]', response.status)

		if (response
			&amp;&amp; response.headers
			&amp;&amp; 'string' === typeof response.headers.link
		) {
			debug('Detected http-header LINK, page is not last', response.headers.link)
			extra.pageIsLast = false
			// TODO: reconsider this property
			extra._headersLink = response.headers.link
		}

		if (response
			&amp;&amp; response.headers
			&amp;&amp; 'string' === typeof response.headers['x-request-id']
		) {
			extra.requestId = response.headers['x-request-id']
		}

		switch(response.status) {
		// SUCCESS
		// https://httpstatuses.com/200 OK
		// https://httpstatuses.com/201 Created
		case 200:
		case 201:
			return cb(null, body, extra)

		// SUCCESS for DELETE operations
		// https://httpstatuses.com/204 No Content
		case 204:
			return cb(null, null, extra)

		// https://httpstatuses.com/404 Not found
		case 404:
			debug('path:[%s] raw body: %o',
				response.request.path,
				response.request.body
			)

			// In most casses 404 means, that there is no such entity on requested
			// Freshdesk domain. For example, you are trying to update non-existent
			// contact
			// But, it also could be a result of wrong URL (?!?!?)
			//
			// In most cases the body is EMPTY, so we will just warn about wrong entity
			return cb(new FreshdeskError('The requested entity was not found', data, response))

		// https://httpstatuses.com/409 Conflict  - NOT UNIQUE, where unique required
		case 409:
		default:
			debug('path:[%s] raw body: %o',
				response.request.path,
				response.request.data
			)
			return cb(new FreshdeskError(body.description, body, response))
		}
	}
}

// TODO: try to make less params here
async function makeRequest(method, auth, url, qs, data, cb) {		// eslint-disable-line max-params
	const options = {
		method: method,
		headers: {
			'Content-Type': 'application/json',
			'Authorization': auth
		},
		url: url, // for debugging set to: "https://httpbin.org/get"
		params: qs
	}

	if (data) {
		if ('attachments' in data &amp;&amp; Array.isArray(data.attachments)) {
			var form = new FormData();

			for (let i = 0; i &lt; Object.keys(data).length; i++) {
				const key = Object.keys(data)[i];
				if (Array.isArray(data[key])) {
					for (let i = 0; i &lt; data[key].length; i++) {
						form.append(key + '[]', data[key][i])
					}
				} else {
					form.append(key, data[key])
				}
			}

			options.headers['Content-Type'] = form.getHeaders()['content-type']
			options.data = form
		} else {
			options.data = JSON.stringify(data)
		}
	}

	try {
		const response = await axios(options);
		return createResponseHandler(cb)(null, response, response.data);
	} catch (error) {
		if (error.response) {
			return createResponseHandler(cb)(null, error.response, error.response.data);
		} else if (error.request) {
			return createResponseHandler(cb)(new Error(error.message), error.request, error.request.data);
		} else {
			return createResponseHandler(cb)(error, error.request, error.request.data);
		}
	}
}

/**
 * Checks if value is null or undefined.
 *
 * @private
 *
 * @param  {*}       value    The value to check.
 * @return {boolean}          Returns `true` if value is `null` or `undefined`; else `false`.
 *
 */
function isNil(value) {
	if (value === null || typeof value === 'undefined') {
		return true
	}

	return false
}

/**
 * Checks if value is classified as a Function object.
 *
 * @private
 *
 * @param  {*}       value    The value to check.
 * @return {boolean}          Returns `true` if value is a `function`; else `false`.
 */
function isFunction(value) {
	return typeof value === 'function'
}

module.exports.makeRequest = makeRequest
module.exports.FreshdeskError = FreshdeskError
module.exports.isNil = isNil
module.exports.isFunction = isFunction
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.4</a> on Sun Sep 26 2021 00:14:15 GMT+0000 (Coordinated Universal Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
